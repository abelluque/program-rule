package com.ablehealth;

import com.ablehealth.model.*
import com.ablehealth.payloads.*;
import com.ablehealth.results.*;

import accumulate com.ablehealth.functions.LatestClinicalActivityAccumulateFunction latestClinicalActivity;

global PatientResults controlSet;

rule 'Year2019.Cms138v7Rate2.Denominator'
when
    $program: Program(rules contains 'measure.Cms.2019.Cms138v7Rate2')
    Year2019Cms138v7PreventiveVisit($encounter: encounter)
    Year2019Cms138v7TobaccoUser($screening: screening)
then
    insert(new EncounterDenominator($program, $encounter, 'Year2019.Cms138v7Rate2'));
    insert(new GroupEncounterDenominator($program, $encounter, 'Year2019.Cms138v7Rate2'));
    insert(new ProviderEncounterDenominator($program, $encounter, 'Year2019.Cms138v7Rate2'));
end

rule 'Year2019.Cms138v7Rate2.Denominator.TwoVisits.Org'
when
    $program: Program(rules contains 'measure.Cms.2019.Cms138v7Rate2')
    Year2019Cms138v7TwoVisitsOrg($encounter: encounter)
    Year2019Cms138v7TobaccoUser($screening: screening)
then
    insert(new EncounterDenominator($program, $encounter, 'Year2019.Cms138v7Rate2'));
end

rule 'Year2019.Cms138v7Rate2.Denominator.TwoVisits.Group'
when
    $program: Program(rules contains 'measure.Cms.2019.Cms138v7Rate2')
    Year2019Cms138v7TwoVisitsGroup($encounter: encounter)
    Year2019Cms138v7TobaccoUser($screening: screening)
then
    insert(new GroupEncounterDenominator($program, $encounter, 'Year2019.Cms138v7Rate2'));
end

rule 'Year2019.Cms138v7Rate2.Denominator.TwoVisits.Provider'
when
    $program: Program(rules contains 'measure.Cms.2019.Cms138v7Rate2')
    Year2019Cms138v7TwoVisitsProvider($encounter: encounter)
    Year2019Cms138v7TobaccoUser($screening: screening)
then
    insert(new ProviderEncounterDenominator($program, $encounter, 'Year2019.Cms138v7Rate2'));
end

rule 'Year2019.Cms138v7Rate2.Success.performance_met.Org'
when
    EncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
    Year2019Cms138v7Counseling()
then
    controlSet.addPatientMeasureStatus($program, $patient, 'Year2019.Cms138v7Rate2', MeasureStatusValue.SUCCESS, "performance_met");
end

rule 'Year2019.Cms138v7Rate2.Success.performance_met.Group'
when
    GroupEncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
    Year2019Cms138v7Counseling()
then
    controlSet.addGroupPatientMeasureStatus($program, $patient, $encounter.groupExternalId,'Year2019.Cms138v7Rate2', MeasureStatusValue.SUCCESS, "performance_met");
end

rule 'Year2019.Cms138v7Rate2.Success.performance_met.Provider'
when
    ProviderEncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
    Year2019Cms138v7Counseling()
then
    controlSet.addProviderPatientMeasureStatus($program, $patient, $encounter.providerExternalId,'Year2019.Cms138v7Rate2', MeasureStatusValue.SUCCESS, "performance_met");
end

rule 'Year2019.Cms138v7Rate2.Exception.exception_medicalreason.Org'
when
    EncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
    (
        Year2019Cms138v7MedicalReasonCounseling()
        or Year2019Cms138v7LimitedLife()
    )
then
    controlSet.addPatientMeasureStatus($program, $patient, 'Year2019.Cms138v7Rate2', MeasureStatusValue.EXCEPTION, "exception_medicalreason");
end

rule 'Year2019.Cms138v7Rate2.Exception.exception_medicalreason.Group'
when
    GroupEncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
    (
        Year2019Cms138v7MedicalReasonCounseling()
        or Year2019Cms138v7LimitedLife()
    )
then
    controlSet.addGroupPatientMeasureStatus($program, $patient, $encounter.groupExternalId,'Year2019.Cms138v7Rate2', MeasureStatusValue.EXCEPTION, "exception_medicalreason");
end

rule 'Year2019.Cms138v7Rate2.Exception.exception_medicalreason.Provider'
when
    ProviderEncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
    (
        Year2019Cms138v7MedicalReasonCounseling()
        or Year2019Cms138v7LimitedLife()
    )
then
    controlSet.addProviderPatientMeasureStatus($program, $patient, $encounter.providerExternalId,'Year2019.Cms138v7Rate2', MeasureStatusValue.EXCEPTION, "exception_medicalreason");
end

rule 'Year2019.Cms138v7Rate2.Gap.performance_not_met.Org'
when
    EncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
then
    controlSet.addPatientMeasureStatus($program, $patient, 'Year2019.Cms138v7Rate2', MeasureStatusValue.GAP, "performance_not_met");
end

rule 'Year2019.Cms138v7Rate2.Gap.performance_not_met.Group'
when
    GroupEncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
then
    controlSet.addGroupPatientMeasureStatus($program, $patient, $encounter.groupExternalId,'Year2019.Cms138v7Rate2', MeasureStatusValue.GAP, "performance_not_met");
end

rule 'Year2019.Cms138v7Rate2.Gap.performance_not_met.Provider'
when
    ProviderEncounterDenominator($program: program, $encounter: clinicalActivity, measure == 'Year2019.Cms138v7Rate2')
    $patient: Patient()
then
    controlSet.addProviderPatientMeasureStatus($program, $patient, $encounter.providerExternalId,'Year2019.Cms138v7Rate2', MeasureStatusValue.GAP, "performance_not_met");
end
